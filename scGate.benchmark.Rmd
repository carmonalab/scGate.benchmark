---
title: "Intuitive Immune Isolation of cell types with scGate. Basic examples"
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "29/09/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'scGate.basic.usage.html'))})
---


```{r, message=F, warning=F,results=F}
#install.packages("renv")
renv::activate()
renv::restore()
#install.packages(c("ggplot2","dplyr","remotes","Seurat","rmarkdown","knitr","rmdformats","ggparty","BiocManager"))
#BiocManager::install(c("SingleR","BiocParallel","celldex"))
BiocManager::install("celldex")
#remotes::install_github("carmonalab/UCell")
#remotes::install_github("carmonalab/scGate", ref='dev')
library(ggplot2)
library(dplyr)
library(scGate)
library(SingleR)
#renv::snapshot()
```

## Load some testing datasets and models

Load datasets (you will need ~ 14gb of RAM)
```{r}
#testing.datasets <- scGate:::get_testing_data(version = 'hsa.latest')  # small sampled version of testing datasets
testing.datasets <- readRDS("~/Dropbox/CSI/Datasets/human/human_sets_benchmark.rds") 
#saveRDS(object =  testing_dsets, "./aux/human_sets_benchmark.rds")
figure.path <- "./plots/"
dir.create(figure.path)

```

Load default models from DB
```{r}
models.DB <- scGate::get_scGateDB(force_update = T)
models <- models.DB$human$generic  ## Human generic is a set of models trained for general purposes
print(models%>%names)

```

or alternatively, you can load models from your own personalized folder
```{r}
# models_path = '/home/user/path_to_your_own_model_folder'
# models <- scGate::load_models(models_path) 
```

### Have a look at some model
```{r, fig.height= 6,fig.width= 6, message=F,results=F}
model.name <- "Bcell"
model <- models[[model.name]]
plt.tree <- scGate::plot_tree(model)
plt.tree
```

Add reference levels for performance computing on SingleR
```{r}
ground_truth_categories <- readRDS("./aux/SingleR_goldStandard.rds")  #
```


## Run models and compute performance

```{r}
## SinlgeR
hpca.se <- HumanPrimaryCellAtlasData() 
param <- BiocParallel::MulticoreParam(workers = 4)

dset.to.run <- names(testing.datasets)

res.SingleR <- list()
SingleR.output <- list()
for(dset in dset.to.run){
    obj <- testing.datasets[[dset]]
    SingleR.output[[dset]] <- SingleR(test = GetAssayData(obj), ref = hpca.se,labels = hpca.se$label.fine, BPPARAM=param)
    res.SingleR[[dset]][["SingleR.fine"]] <- SingleR.output[[dset]]$pruned.labels
}
```


run scGate
```{r,collapse =T, results= F, echo = F}
# List available testing datasets:
t0 <- Sys.time()
results <- data.frame()
models <- models[names(models)!="Tcell.alphabeta"]


for(dset in dset.to.run){
  message(sprintf('runing %s',dset))
  obj <- testing.datasets[[dset]]
  assay <-  DefaultAssay(obj)
  

  for(model.name in names(models)){
    message(sprintf('runing %s',model.name))
    model <- models[[model.name]]
    obj <- scGate(data = obj, model = model, ncores = 4, keep.ranks = TRUE, output.col.name = paste0('is.pure.',model.name), assay = assay)
    
    res <- scGate::performance.metrics(actual = obj@meta.data[,model.name], pred = obj@meta.data[,paste0("is.pure.",model.name)] == "Pure")
    res <- data.frame(value = res, metric = names(res),model = model.name,dataset = dset,method = "scGate")
    results <- rbind(results,res)
    
    #merge SingleR results
    pred.singleR <- (res.SingleR[[dset]])$SingleR.fine%>%grepl(ground_truth_categories$hpca_categories[[model.name]],.)+0
    singleR <- scGate::performance.metrics(actual = obj@meta.data[,model.name], pred = pred.singleR == 1)
    singleR <- data.frame(value = singleR, metric = names(singleR),model = model.name,dataset = dset,method = 'SingleR')
    results <- rbind(results,singleR)
  }

}
t1 <- Sys.time()
print(t1-t0)
```


## performance visualization


```{r,fig.wirth = 8,fig.height=5}

data_summary <- function(x) {
   m <- mean(x)
   se <- function(x) sqrt(var(x)/length(x))
   ymin <- m-se(x)
   ymax <- m+se(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}

res <- results%>%subset(metric %in% c("PREC","MCC") & model!= "Plasma_cell")


res.prec <- res%>%subset(metric == "PREC")
res.mcc <- res%>%subset(metric == "MCC")

plt.prec <- plts <- ggplot(res.prec, aes(x=model, y=value, color = method )) + geom_jitter(position=position_jitterdodge(jitter.width = 0.2), size = 0.4) +
  stat_summary(fun.data=data_summary,position=position_dodge(0.8), shape = 4, size = 0.25) + 
  ylab("Precision")   + theme_bw() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.4, hjust=0.5)) 
  


plt.mcc  <- ggplot(res.mcc, aes(x=model, y=value, color=method )) + geom_jitter(position=position_jitterdodge(jitter.width = 0.2), size = 0.4) +
#  scale_color_manual(values=c("#E69F00", "#56B4E9")) + 
  stat_summary(fun.data=data_summary,  
               position=position_dodge(0.8), shape = 4, size = 0.25) + 
  ylab("MCC")  + theme_bw() +
  theme(legend.position = c(0.85, 0.15), legend.title = element_blank()) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 0.4, hjust=0.5))

plts  = plt.prec + plt.mcc
plts
```


```{r,echo =FALSE, results=F}
saveRDS(results,file = file.path(figure.path,"benchmark_20102021_scGate.rds")) 
ggsave(file.path(figure.path,"benchmark_20102021_scGate.png"), plot=plts, width=9, height=5)
ggsave(file.path(figure.path,"benchmark_20102021_scGate.pdf"), plot=plts, width=9, height=5)

```


